{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <section class="scammers-header">
        <div class="header-content">
            <h2>Detected Scammers</h2>
            <div class="filter-controls">
                <select id="timeFilter" class="filter-select">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d" selected>Last 30 Days</option>
                    <option value="all">All Time</option>
                </select>
                <select id="statusFilter" class="filter-select">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="appealed">Appealed</option>
                    <option value="reversed">Reversed</option>
                </select>
                <input type="text" id="searchInput" class="search-input" placeholder="Search by username or ID...">
            </div>
        </div>
    </section>

    <section class="scammers-list">
        <div class="table-container">
            <table class="scammers-table">
                <thead>
                    <tr>
                        <th>User Info</th>
                        <th>Detection Score</th>
                        <th>Action Taken</th>
                        <th>Evidence</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scammer in scammers %}
                    <tr data-user-id="{{ scammer.user_id }}">
                        <td class="user-info">
                            <img src="{{ scammer.avatar_url }}" alt="Avatar" class="user-avatar">
                            <div class="user-details">
                                <span class="username">{{ scammer.username }}</span>
                                <span class="user-id">{{ scammer.user_id }}</span>
                                <span class="detection-date">{{ scammer.detected_at|datetime }}</span>
                            </div>
                        </td>
                        <td class="score-cell">
                            <div class="score-badge {% if scammer.score >= 0.9 %}high-risk{% elif scammer.score >= 0.7 %}medium-risk{% else %}low-risk{% endif %}">
                                {{ "%.2f"|format(scammer.score) }}
                            </div>
                        </td>
                        <td class="action-cell">
                            <span class="action-badge {{ scammer.action }}">
                                {{ scammer.action|title }}
                            </span>
                        </td>
                        <td class="evidence-cell">
                            <button class="view-evidence-btn" onclick="viewEvidence('{{ scammer.user_id }}')">
                                View Evidence
                            </button>
                        </td>
                        <td class="status-cell">
                            <span class="status-badge {{ scammer.status }}">
                                {{ scammer.status|title }}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                {% if scammer.status == 'active' %}
                                <button class="reverse-btn" onclick="reverseAction('{{ scammer.user_id }}')">
                                    Reverse Action
                                </button>
                                {% endif %}
                                <button class="details-btn" onclick="viewDetails('{{ scammer.user_id }}')">
                                    Details
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="pagination">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}" class="page-btn">Previous</a>
            {% endif %}
            
            <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
            
            {% if page < total_pages %}
            <a href="?page={{ page + 1 }}" class="page-btn">Next</a>
            {% endif %}
        </div>
    </section>

    <!-- Evidence Modal -->
    <div id="evidenceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detection Evidence</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="evidence-details">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.scammers-header {
    background-color: var(--surface-color);
    padding: var(--spacing-lg);
    border-radius: var(--border-radius);
    margin-bottom: var(--spacing-lg);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--spacing-md);
}

.filter-controls {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.filter-select, .search-input {
    background-color: var(--secondary-color);
    color: var(--text-color);
    border: 1px solid var(--text-muted);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius);
}

.table-container {
    background-color: var(--surface-color);
    border-radius: var(--border-radius);
    overflow-x: auto;
}

.scammers-table {
    width: 100%;
    border-collapse: collapse;
}

.scammers-table th,
.scammers-table td {
    padding: var(--spacing-md);
    text-align: left;
    border-bottom: 1px solid var(--secondary-color);
}

.user-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.user-details {
    display: flex;
    flex-direction: column;
}

.username {
    font-weight: 500;
}

.user-id, .detection-date {
    font-size: 0.9em;
    color: var(--text-muted);
}

.score-badge {
    display: inline-block;
    padding: 0.25em 0.75em;
    border-radius: 1em;
    font-weight: 500;
}

.score-badge.high-risk { background-color: var(--danger-color); }
.score-badge.medium-risk { background-color: var(--warning-color); color: #000; }
.score-badge.low-risk { background-color: var(--success-color); }

.action-badge {
    display: inline-block;
    padding: 0.25em 0.75em;
    border-radius: 1em;
    text-transform: capitalize;
}

.action-badge.warn { background-color: var(--warning-color); color: #000; }
.action-badge.kick { background-color: var(--primary-color); }
.action-badge.ban { background-color: var(--danger-color); }

.status-badge {
    display: inline-block;
    padding: 0.25em 0.75em;
    border-radius: 1em;
    text-transform: capitalize;
}

.status-badge.active { background-color: var(--danger-color); }
.status-badge.appealed { background-color: var(--warning-color); color: #000; }
.status-badge.reversed { background-color: var(--text-muted); }

.action-buttons {
    display: flex;
    gap: var(--spacing-sm);
}

.view-evidence-btn,
.reverse-btn,
.details-btn {
    padding: 0.25em 0.75em;
    border-radius: var(--border-radius);
    border: none;
    cursor: pointer;
    font-size: 0.9em;
}

.view-evidence-btn {
    background-color: var(--primary-color);
    color: white;
}

.reverse-btn {
    background-color: var(--danger-color);
    color: white;
}

.details-btn {
    background-color: var(--surface-color);
    border: 1px solid var(--text-muted);
    color: var(--text-color);
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
}

.page-btn {
    background-color: var(--primary-color);
    color: white;
    padding: 0.5em 1em;
    border-radius: var(--border-radius);
    text-decoration: none;
}

.page-info {
    color: var(--text-muted);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

.modal-content {
    background-color: var(--surface-color);
    margin: 10% auto;
    padding: var(--spacing-lg);
    border-radius: var(--border-radius);
    max-width: 600px;
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.close-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5em;
    cursor: pointer;
}

.close-btn:hover {
    color: var(--text-color);
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Setup filter handlers
    const timeFilter = document.getElementById('timeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const searchInput = document.getElementById('searchInput');

    function applyFilters() {
        const params = new URLSearchParams(window.location.search);
        params.set('time', timeFilter.value);
        params.set('status', statusFilter.value);
        if (searchInput.value) {
            params.set('search', searchInput.value);
        } else {
            params.delete('search');
        }
        window.location.search = params.toString();
    }

    timeFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 500);
    });

    // Setup modal
    const modal = document.getElementById('evidenceModal');
    const closeBtn = modal.querySelector('.close-btn');
    
    closeBtn.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
});

async function viewEvidence(userId) {
    try {
        const response = await fetch(`/api/scammers/${userId}/evidence`);
        const data = await response.json();
        
        const modal = document.getElementById('evidenceModal');
        const evidenceDetails = modal.querySelector('.evidence-details');
        
        // Populate evidence details
        evidenceDetails.innerHTML = `
            <h4>Detection Details</h4>
            <div class="evidence-item">
                <strong>Detection Time:</strong> ${new Date(data.detected_at).toLocaleString()}
            </div>
            <div class="evidence-item">
                <strong>Detection Score:</strong> ${data.score.toFixed(2)}
            </div>
            <div class="evidence-item">
                <strong>Triggered Checks:</strong>
                <ul>
                    ${data.triggered_checks.map(check => `
                        <li>
                            <strong>${check.name}:</strong> ${check.details}
                            <div class="check-score">Score: ${check.score.toFixed(2)}</div>
                        </li>
                    `).join('')}
                </ul>
            </div>
            ${data.screenshot ? `
                <div class="evidence-item">
                    <strong>Screenshot:</strong>
                    <img src="${data.screenshot}" alt="Evidence Screenshot" class="evidence-screenshot">
                </div>
            ` : ''}
        `;
        
        modal.style.display = "block";
    } catch (error) {
        console.error('Error fetching evidence:', error);
    }
}

async function reverseAction(userId) {
    if (!confirm('Are you sure you want to reverse this action?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/scammers/${userId}/reverse`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            // Refresh the page to show updated status
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`Failed to reverse action: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error reversing action:', error);
        alert('An error occurred while trying to reverse the action');
    }
}

function viewDetails(userId) {
    window.location.href = `/scammers/${userId}`;
}
</script>
{% endblock %}